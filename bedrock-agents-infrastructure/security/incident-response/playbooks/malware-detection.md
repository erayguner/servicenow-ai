# Malware Detection Response Playbook

## Overview
Response procedures for detected or suspected malware in Bedrock agents infrastructure.

## Detection Criteria
- Antivirus/Antimalware alert
- Amazon GuardDuty malware finding
- Behavioral anomaly detection
- Unexpected process execution
- Suspicious binary execution
- Hash match against known malware signatures
- Network IOC (Indicator of Compromise) match
- Unexpected network connections
- Suspicious scheduled tasks
- Runtime behavior alerts

## Severity Classification

### Critical (P1)
- Ransomware detected
- Data exfiltration malware
- Active propagation/worm
- Multiple systems infected
- Production systems compromised
- Rootkit/kernel-level compromise

### High (P2)
- Backdoor/remote access malware
- Credential stealer
- 2-5 systems infected
- Active command & control communication
- Potential data access

### Medium (P3)
- Single system infection
- Low propagation risk
- Limited damage capability
- Automated detection (false positive unlikely)
- Contained environment

### Low (P4)
- Dormant/inactive malware
- Non-malicious PUA detected
- Potential false positive
- Offline system
- No network access

## Response Steps

### Phase 1: Immediate Response (0-1 hour)

1. **Alert Verification**
   - Confirm malware detection legitimate
   - Identify affected system(s)
   - Determine malware type/family
   - Check detection confidence level
   - Review alert source reliability

2. **Initial Containment**
   - Isolate affected system immediately
   - Disconnect from network
   - Execute `isolate-compromised-agent.json` runbook
   - Preserve evidence (do not reboot)
   - Document initial findings

3. **System Preservation**
   - Execute `enable-forensics-mode.json` runbook
   - Capture memory dump (for analysis)
   - Create filesystem snapshots
   - Preserve system logs
   - Document execution environment

4. **Threat Assessment**
   - Determine propagation mechanism
   - Identify infection vector
   - Review network connections
   - Check for lateral movement
   - Estimate time of infection

### Phase 2: Investigation (1-4 hours)

1. **Forensic Analysis**
   - Execute `capture-logs.py` for complete logs
   - Run `memory-dump.py` for memory analysis
   - Execute `snapshot-resources.py` for resources
   - Analyze suspicious process execution
   - Review network traffic (PCAP analysis)

2. **Scope Determination**
   - Identify all affected systems
   - Check for lateral movement
   - Review network shares accessed
   - Analyze credentials accessed
   - Determine propagation method

3. **Timeline Construction**
   - Run `timeline-builder.py` for incident timeline
   - Identify initial infection point
   - Map execution sequence
   - Document persistence mechanisms
   - Determine attacker actions

4. **Malware Analysis**
   - Quarantine malware samples
   - Static analysis (strings, headers, etc.)
   - Dynamic analysis (sandboxed execution)
   - Identify malware family/variant
   - Extract IOCs (IP, domains, hashes)

### Phase 3: Containment (1-24 hours)

1. **Isolation**
   - Keep affected systems offline
   - Block C&C (Command & Control) domains
   - Block known IOC IP addresses
   - Revoke credentials on affected systems
   - Block propagation paths

2. **Forensic Preservation**
   - Image affected systems (full clone)
   - Store disk images securely
   - Preserve chain of custody
   - Document all findings
   - Tag resources for analysis

3. **Related System Review**
   - Scan all systems for same malware
   - Check for lateral movement evidence
   - Review network traffic patterns
   - Scan shared resources
   - Monitor for resurgence

4. **Credential Management**
   - Rotate all credentials on affected systems
   - Execute `rotate-all-credentials.json` runbook
   - Change passwords for accessed accounts
   - Revoke API keys
   - Reset service account passwords

## Containment Procedures

### System Isolation
```bash
# 1. Network Isolation
- Disconnect from network immediately
- Remove from security groups
- Block outbound traffic to known IPs
- Isolate in separate VPC if needed
- Monitor for C&C attempts

# 2. Access Revocation
- Terminate all sessions
- Revoke SSH keys
- Disable remote access
- Lock local accounts
- Revoke API credentials

# 3. Process Termination
- Stop suspicious processes
- Kill malware processes
- Terminate network connections
- Stop scheduled tasks
- Disable auto-start mechanisms
```

### IOC Blocking
```bash
# 1. Network Level
- Block C&C domains at firewall/DNS
- Block known malware IP addresses
- Update WAF rules
- Configure IDS/IPS signatures
- Monitor for alternative C&C

# 2. Endpoint Level
- Quarantine malware files
- Block file execution
- Disable auto-run features
- Monitor file access
- Log file execution attempts
```

### Propagation Prevention
```bash
# 1. Lateral Movement Prevention
- Block network shares
- Disable network services
- Revoke service credentials
- Implement network segmentation
- Monitor for propagation attempts

# 2. Persistence Removal
- Delete malware files
- Remove scheduled tasks
- Clear browser extensions
- Remove registry entries
- Delete startup scripts
```

## Eradication Steps

### Malware Removal
- [ ] Delete all malware files identified
- [ ] Remove persistence mechanisms
- [ ] Disable malware services
- [ ] Clear configuration files
- [ ] Validate removal with scans

### System Hardening
- [ ] Update antivirus signatures
- [ ] Patch operating system
- [ ] Update applications
- [ ] Remove unnecessary services
- [ ] Implement EDR agent

### Vulnerability Remediation
- [ ] Identify infection vector
- [ ] Apply security patches
- [ ] Review system configuration
- [ ] Strengthen access controls
- [ ] Update firewall rules

### System Restoration
- [ ] Rebuild from clean image
- [ ] Restore from clean backup
- [ ] Validate restoration
- [ ] Confirm functionality
- [ ] Test security controls

## Recovery Procedures

### Clean System Restoration
1. Identify clean golden image
2. Rebuild system from image
3. Apply security patches
4. Install antivirus/EDR
5. Restore user data from clean backup

### Service Bring-Up
1. Restore in priority order
2. Validate functionality
3. Monitor for anomalies
4. Confirm security controls
5. Test incident response

### Verification
1. Scan for remaining malware
2. Confirm no persistence mechanisms
3. Validate monitoring active
4. Test system functionality
5. Document lessons learned

## Post-Incident Review

### Forensic Findings
- Malware family/variant identification
- Initial infection vector
- Infection duration
- Systems/data affected
- Attacker capabilities

### Propagation Analysis
- Lateral movement methods
- Propagation vectors
- Affected systems count
- Network paths used
- Persistence mechanisms

### Control Gaps
- Insufficient endpoint protection
- Inadequate monitoring
- Weak access controls
- Missing patches
- Detection delays

### Improvement Actions
- Enhanced endpoint protection
- Behavioral monitoring
- Vulnerability management
- Access restriction
- Detection improvements

## Prevention Measures

### Endpoint Protection
- Antivirus/Antimalware on all systems
- EDR (Endpoint Detection & Response)
- Host-based firewall
- File integrity monitoring
- Process whitelisting

### Vulnerability Management
- Regular patching program
- Vulnerability scanning
- Configuration management
- Software inventory
- Supply chain security

### Monitoring & Detection
- File integrity monitoring
- Network behavior analysis
- Process execution monitoring
- Registry monitoring
- Log analysis and alerting

### User Security
- Security awareness training
- Email filtering
- Web content filtering
- USB/external media controls
- Application whitelisting

## Tools & Resources

### Malware Analysis
- VirusTotal
- Hybrid Analysis
- YARA rules
- MITRE ATT&CK framework
- Threat intelligence feeds

### Forensics Tools
- memory-dump.py
- capture-logs.py
- snapshot-resources.py
- timeline-builder.py
- network-capture.py

### Protection Tools
- Amazon GuardDuty
- AWS Systems Manager
- Antivirus/EDR solutions
- Network monitoring

### Response Runbooks
- isolate-compromised-agent.json
- enable-forensics-mode.json
- rotate-all-credentials.json
- collect-evidence.json
- notify-stakeholders.json

## Metrics & KPIs

Track during incident:
- **Detection to Isolation**: < 15 minutes
- **Isolation to Analysis**: < 1 hour
- **Analysis to Mitigation**: < 4 hours
- **Mitigation to Eradication**: < 24 hours
- **Time to Recovery**: < 72 hours
- **False Positive Rate**: < 2%

## Decision Tree

```
Malware Detected?
├─ Verify Detection
│  ├─ Confirmed: Proceed with response
│  └─ False Positive: Log and monitor
├─ Severity Assessment
│  ├─ P1: Full activation
│  ├─ P2: Limited activation
│  └─ P3/P4: Standard response
├─ Containment
│  ├─ Isolated: Analyze and plan
│  └─ Not Isolated: Isolate immediately
└─ Recovery
   ├─ Removable: Clean and verify
   └─ Not Removable: Rebuild
```

## Related Playbooks
- [Compromised Credentials Response](./compromised-credentials.md)
- [Data Breach Response](./data-breach-response.md)
- [Unauthorized Access Response](./unauthorized-access.md)

## Contacts & Escalation

### Response Team
- **Security Lead**: [On-call rotation]
- **Forensics Specialist**: [On-call rotation]
- **System Administrator**: [On-call rotation]
- **CISO**: [For major incidents]

### External Resources
- **SANS Internet Storm Center**: https://isc.sans.edu
- **Malware Information Sharing**: https://www.misp-project.org
- **Threat Intelligence Feeds**: [Vendor specific]

## Revision History
- v1.0 - Initial creation (2024-11-17)
