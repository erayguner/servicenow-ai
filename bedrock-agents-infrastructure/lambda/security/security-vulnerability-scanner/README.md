# Security Vulnerability Scanner

Automated vulnerability scanner for Lambda dependencies, Docker images, and package versions.

## Features

- **Lambda Dependency Scanning**: Scans Node.js, Python, and other runtime dependencies
- **Docker Image Scanning**: Integrates with ECR image scanning for container vulnerabilities
- **Package Version Checking**: Identifies outdated and vulnerable packages
- **Security Hub Integration**: Reports findings to AWS Security Hub
- **Automated Remediation**: Creates tickets for critical vulnerabilities
- **Real-time Notifications**: SNS alerts for high-severity findings

## Supported Scan Types

### 1. LAMBDA
Scans Lambda function dependencies:
- Node.js (package.json, package-lock.json)
- Python (requirements.txt)
- Java (pom.xml, build.gradle)
- .NET (packages.config)

### 2. DOCKER
Scans container images in ECR:
- OS package vulnerabilities
- Application dependencies
- Base image vulnerabilities
- Layer-specific issues

### 3. PACKAGES
Scans package files:
- npm packages
- pip packages
- Maven dependencies
- Gradle dependencies

## Environment Variables

| Variable | Description | Required | Default |
|----------|-------------|----------|---------|
| `SECURITY_HUB_ENABLED` | Enable Security Hub reporting | No | true |
| `NOTIFICATION_TOPIC_ARN` | SNS topic for notifications | Yes | - |
| `REMEDIATION_QUEUE_URL` | SQS queue for remediation tickets | Yes | - |
| `SEVERITY_THRESHOLD` | Minimum severity to report | No | MEDIUM |
| `AWS_ACCOUNT_ID` | AWS Account ID | Yes | - |
| `AWS_REGION` | AWS Region | Yes | - |

## Event Structure

### Scan All Lambda Functions
```json
{
  "scanTypes": ["LAMBDA"]
}
```

### Scan Specific Lambda Functions
```json
{
  "scanTypes": ["LAMBDA"],
  "lambdaFunctions": [
    "bedrock-agent-function-1",
    "bedrock-agent-function-2"
  ]
}
```

### Scan Docker Images
```json
{
  "scanTypes": ["DOCKER"],
  "ecrRepositories": [
    "bedrock-agent-api",
    "bedrock-worker"
  ]
}
```

### Scan Package Files
```json
{
  "scanTypes": ["PACKAGES"],
  "packageFiles": [
    "/app/package.json",
    "/api/requirements.txt"
  ]
}
```

### Combined Scan
```json
{
  "scanTypes": ["LAMBDA", "DOCKER", "PACKAGES"],
  "lambdaFunctions": ["function-1", "function-2"],
  "ecrRepositories": ["repo-1"],
  "packageFiles": ["/app/package.json"],
  "severityThreshold": "HIGH"
}
```

## Response Structure

```json
{
  "scanId": "scan-1234567890",
  "timestamp": "2025-01-17T10:00:00.000Z",
  "totalVulnerabilities": 15,
  "criticalCount": 2,
  "highCount": 5,
  "mediumCount": 6,
  "lowCount": 2,
  "scanDuration": 45000,
  "scanTypes": ["LAMBDA", "DOCKER"],
  "remediationTicketsCreated": 7,
  "vulnerabilities": [
    {
      "type": "PACKAGE",
      "id": "function-1-lodash-CVE-2020-8203",
      "title": "CVE-2020-8203 in lodash",
      "description": "Prototype pollution vulnerability in lodash",
      "severity": "HIGH",
      "cvssScore": 7.4,
      "cveId": "CVE-2020-8203",
      "packageName": "lodash",
      "packageVersion": "4.17.15",
      "fixedVersion": "4.17.21",
      "packageManager": "npm",
      "functionName": "bedrock-agent-function-1",
      "remediation": "Update lodash to version 4.17.21 or later",
      "riskScore": 75
    },
    {
      "type": "IMAGE",
      "id": "repo-1-sha256:abc123-CVE-2021-1234",
      "title": "CVE-2021-1234 in openssl",
      "description": "Buffer overflow in OpenSSL",
      "severity": "CRITICAL",
      "cvssScore": 9.8,
      "cveId": "CVE-2021-1234",
      "imageUri": "repo-1@sha256:abc123",
      "imageDigest": "sha256:abc123",
      "repositoryName": "repo-1",
      "packageName": "openssl",
      "packageVersion": "1.1.1",
      "fixedVersion": "1.1.1k",
      "riskScore": 95
    }
  ]
}
```

## Vulnerability Severities

| Severity | CVSS Score | Risk Score | Action |
|----------|------------|------------|--------|
| CRITICAL | 9.0 - 10.0 | 90-100 | Immediate remediation required |
| HIGH | 7.0 - 8.9 | 70-89 | Remediation within 7 days |
| MEDIUM | 4.0 - 6.9 | 40-69 | Remediation within 30 days |
| LOW | 0.1 - 3.9 | 1-39 | Remediation as time permits |

## Risk Score Calculation

Risk score (0-100) is calculated based on:
- **Base severity** (40-90 points)
- **CVSS score** (up to 100 points)
- **Exploit availability** (+20 points)
- **Patch availability** (-10 points)

## IAM Permissions Required

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "lambda:ListFunctions",
        "lambda:GetFunction",
        "ecr:DescribeImages",
        "ecr:DescribeImageScanFindings",
        "ecr:StartImageScan",
        "securityhub:BatchImportFindings",
        "sns:Publish",
        "sqs:SendMessage"
      ],
      "Resource": "*"
    }
  ]
}
```

## Integration with Security Hub

Findings are reported to Security Hub with:
- Standardized severity levels
- CVE identifiers
- Package/image details
- Remediation recommendations
- Resource tagging

## Automated Remediation

For CRITICAL and HIGH vulnerabilities:
1. Ticket created in remediation queue
2. Priority assigned (P0 for CRITICAL, P1 for HIGH)
3. SNS notification sent to security team
4. Security Hub finding created

## Scheduled Scanning

Configure EventBridge rule for regular scans:

```bash
aws events put-rule \
  --name daily-vulnerability-scan \
  --schedule-expression "cron(0 2 * * ? *)"

aws events put-targets \
  --rule daily-vulnerability-scan \
  --targets "Id"="1","Arn"="arn:aws:lambda:us-east-1:123456789012:function:security-vulnerability-scanner"
```

## Testing

```bash
npm test
npm run test:coverage
```

## Severity Threshold

Set `SEVERITY_THRESHOLD` to filter results:
- `LOW`: Report all vulnerabilities
- `MEDIUM`: Report MEDIUM, HIGH, and CRITICAL
- `HIGH`: Report only HIGH and CRITICAL
- `CRITICAL`: Report only CRITICAL

## Lambda Dependency Scanning

The scanner checks:
- Direct dependencies
- Transitive dependencies
- Development dependencies
- Known CVEs in packages
- Outdated package versions
- License compliance issues

## Docker Image Scanning

ECR image scanning includes:
- OS package vulnerabilities
- Application layer vulnerabilities
- Base image vulnerabilities
- Multi-stage build artifacts
- Scan status tracking

## Monitoring

- CloudWatch Logs: `/aws/lambda/security-vulnerability-scanner`
- CloudWatch Metrics:
  - ScansCompleted
  - VulnerabilitiesFound (by severity)
  - RemediationTicketsCreated
  - ScanDuration
- Security Hub for centralized findings

## Best Practices

1. Run scans on deployment
2. Schedule regular scans (daily/weekly)
3. Set appropriate severity thresholds
4. Monitor Security Hub dashboard
5. Automate remediation workflows
6. Keep vulnerability databases updated
7. Track remediation progress
8. Regular security reviews

## Common Vulnerabilities

The scanner detects:
- Prototype pollution (JavaScript)
- SQL injection
- Cross-site scripting (XSS)
- Remote code execution
- Denial of service
- Authentication bypass
- Information disclosure
- Cryptographic issues
