name: Parallel Test Execution

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      shard_count:
        description: 'Number of test shards'
        required: false
        default: '4'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_REGION: europe-west2
  REGISTRY: europe-west2-docker.pkg.dev
  SHARD_COUNT: ${{ github.event.inputs.shard_count || '4' }}

jobs:
  # Job 1: Setup and build
  setup:
    name: Setup & Build
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache.outputs.cache-key }}
      image-tag: ${{ steps.meta.outputs.image-tag }}
      has-node: ${{ steps.detect_node.outputs.has_node }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Detect Node dependencies
      id: detect_node
      run: |
        if find . -name "package-lock.json" -print -quit | grep -q .; then
          echo "has_node=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_node=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Setup Node.js
      if: ${{ steps.detect_node.outputs.has_node == 'true' }}
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Cache dependencies
      if: ${{ steps.detect_node.outputs.has_node == 'true' }}
      id: cache
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      if: steps.detect_node.outputs.has_node == 'true' && steps.cache.outputs.cache-hit != 'true'
      run: npm ci

    - name: Generate image metadata
      id: meta
      run: |
        IMAGE_TAG=$(echo ${{ github.sha }} | cut -c1-7)
        echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

    - name: Upload workspace
      uses: actions/upload-artifact@v4
      with:
        name: workspace
        path: |
          .
          !node_modules
        retention-days: 1

  # Job 2: Terraform validation (parallel by module)
  terraform-validate:
    name: Terraform Validate (${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        module:
          - gke
          - vpc
          - cloudsql
          - kms
          - storage
          - pubsub
          - redis
          - secret_manager
          - vertex_ai
          - firestore
          - workload_identity
          - workload_identity_federation

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v4
      with:
        terraform_version: 1.11.0

    - name: Terraform Init
      working-directory: terraform/modules/${{ matrix.module }}
      run: terraform init -backend=false

    - name: Terraform Validate
      working-directory: terraform/modules/${{ matrix.module }}
      run: terraform validate

    - name: Terraform Format Check
      working-directory: terraform/modules/${{ matrix.module }}
      run: terraform fmt -check -recursive

  # Job 3: Terraform tests (parallel by module)
  terraform-test:
    name: Terraform Test (${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: terraform-validate
    strategy:
      fail-fast: false
      matrix:
        module:
          - gke
          - vpc
          - cloudsql
          - kms
          - storage
          - pubsub
          - redis
          - secret_manager
          - vertex_ai
          - firestore

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v4
      with:
        terraform_version: 1.6.0

    - name: Terraform Init
      working-directory: terraform/modules/${{ matrix.module }}
      run: terraform init -backend=false

    - name: Terraform Test
      working-directory: terraform/modules/${{ matrix.module }}
      run: terraform test

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: terraform-test-results-${{ matrix.module }}
        path: terraform/modules/${{ matrix.module }}/.terraform/tests/
        retention-days: 7

  # Job 4: Unit tests (parallel shards)
  unit-tests:
    name: Unit Tests (Shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ needs.setup.outputs.has-node == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]

    steps:
    - name: Download workspace
      uses: actions/download-artifact@v4
      with:
        name: workspace

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Restore dependencies cache
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

    - name: Run unit tests (Shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
      run: |
        npm test -- \
          --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} \
          --coverage \
          --coverageDirectory=coverage-${{ matrix.shardIndex }} \
          --maxWorkers=4
      env:
        NODE_ENV: test
        SHARD_INDEX: ${{ matrix.shardIndex }}
        SHARD_TOTAL: ${{ matrix.shardTotal }}

    - name: Upload coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage-unit-${{ matrix.shardIndex }}
        path: coverage-${{ matrix.shardIndex }}/
        retention-days: 7

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-unit-${{ matrix.shardIndex }}
        path: test-results/
        retention-days: 7

  # Job 5: Integration tests (parallel by service)
  integration-tests:
    name: Integration Tests (${{ matrix.service }})
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ needs.setup.outputs.has-node == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        service:
          - conversation-manager
          - llm-gateway
          - knowledge-base
          - ticket-monitor
          - action-executor
          - notification-service
          - api-gateway
          - analytics-service

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb-${{ matrix.service }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Download workspace
      uses: actions/download-artifact@v4
      with:
        name: workspace

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Restore dependencies cache
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

    - name: Run integration tests for ${{ matrix.service }}
      run: |
        npm run test:integration -- \
          --testPathPattern=${{ matrix.service }} \
          --coverage \
          --coverageDirectory=coverage-integration-${{ matrix.service }} \
          --maxWorkers=2
      env:
        NODE_ENV: test
        SERVICE_NAME: ${{ matrix.service }}
        DATABASE_URL: postgresql://postgres:testpassword@localhost:5432/testdb-${{ matrix.service }}
        REDIS_URL: redis://localhost:6379

    - name: Upload coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage-integration-${{ matrix.service }}
        path: coverage-integration-${{ matrix.service }}/
        retention-days: 7

  # Job 6: E2E tests with isolated Kubernetes namespaces
  e2e-tests:
    name: E2E Tests (Shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
    runs-on: ubuntu-latest
    needs: [setup, unit-tests]
    if: ${{ needs.setup.outputs.has-node == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3]
        shardTotal: [3]

    steps:
    - name: Download workspace
      uses: actions/download-artifact@v4
      with:
        name: workspace

    - name: Setup kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'v1.28.0'

    - name: Setup kind (Kubernetes in Docker)
      uses: helm/kind-action@v1.8.0
      with:
        cluster_name: test-cluster-${{ matrix.shardIndex }}
        config: |
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
          - role: worker
          - role: worker

    - name: Create isolated namespace
      run: |
        kubectl create namespace e2e-shard-${{ matrix.shardIndex }}
        kubectl label namespace e2e-shard-${{ matrix.shardIndex }} \
          test-shard=${{ matrix.shardIndex }} \
          test-isolation=true

    - name: Deploy test infrastructure
      run: |
        # Apply test-specific manifests
        kubectl apply -f k8s/test/postgres.yaml -n e2e-shard-${{ matrix.shardIndex }}
        kubectl apply -f k8s/test/redis.yaml -n e2e-shard-${{ matrix.shardIndex }}

        # Wait for infrastructure
        kubectl wait --for=condition=ready pod \
          -l app=postgres \
          -n e2e-shard-${{ matrix.shardIndex }} \
          --timeout=300s

    - name: Deploy microservices
      run: |
        # Deploy services with test configuration
        for service in conversation-manager llm-gateway knowledge-base; do
          kubectl apply -f k8s/deployments/${service}.yaml \
            -n e2e-shard-${{ matrix.shardIndex }}
        done

        # Wait for pods to be ready
        kubectl wait --for=condition=ready pod \
          -l tier=backend \
          -n e2e-shard-${{ matrix.shardIndex }} \
          --timeout=300s

    - name: Run E2E tests (Shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
      run: |
        npm run test:e2e -- \
          --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} \
          --maxWorkers=2
      env:
        NODE_ENV: test
        NAMESPACE: e2e-shard-${{ matrix.shardIndex }}
        KUBECONFIG: ${{ env.KUBECONFIG }}

    - name: Collect pod logs on failure
      if: failure()
      run: |
        mkdir -p logs
        for pod in $(kubectl get pods -n e2e-shard-${{ matrix.shardIndex }} -o name); do
          kubectl logs ${pod} -n e2e-shard-${{ matrix.shardIndex }} \
            > logs/$(basename ${pod}).log 2>&1 || true
        done

    - name: Upload pod logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: pod-logs-shard-${{ matrix.shardIndex }}
        path: logs/
        retention-days: 7

    - name: Cleanup namespace
      if: always()
      run: |
        kubectl delete namespace e2e-shard-${{ matrix.shardIndex }} --wait=false

  # Job 7: Security tests (parallel by category)
  security-tests:
    name: Security Tests (${{ matrix.category }})
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ needs.setup.outputs.has-node == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        category:
          - authentication
          - authorization
          - data-protection
          - network-security
          - secrets-management

    steps:
    - name: Download workspace
      uses: actions/download-artifact@v4
      with:
        name: workspace

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Restore dependencies cache
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

    - name: Run security tests for ${{ matrix.category }}
      run: |
        npm run test:security -- \
          --testPathPattern=${{ matrix.category }} \
          --maxWorkers=2
      env:
        SECURITY_TEST_CATEGORY: ${{ matrix.category }}

  # Job 8: Performance tests (parallel by endpoint)
  performance-tests:
    name: Performance Tests (${{ matrix.endpoint }})
    runs-on: ubuntu-latest
    needs: [setup, integration-tests]
    strategy:
      fail-fast: false
      matrix:
        endpoint:
          - api-gateway
          - llm-gateway
          - knowledge-base
          - conversation-manager

    steps:
    - name: Download workspace
      uses: actions/download-artifact@v4
      with:
        name: workspace

    - name: Setup k6 (load testing)
      run: |
        curl https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-linux-amd64.tar.gz -L | tar xvz
        sudo mv k6-v0.47.0-linux-amd64/k6 /usr/local/bin/

    - name: Run performance tests for ${{ matrix.endpoint }}
      run: |
        k6 run \
          --out json=results-${{ matrix.endpoint }}.json \
          --summary-export=summary-${{ matrix.endpoint }}.json \
          tests/performance/${{ matrix.endpoint }}.k6.js
      env:
        K6_VUS: 50
        K6_DURATION: 2m
        TARGET_ENDPOINT: ${{ matrix.endpoint }}

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-results-${{ matrix.endpoint }}
        path: |
          results-${{ matrix.endpoint }}.json
          summary-${{ matrix.endpoint }}.json
        retention-days: 30

  # Job 9: Aggregate results and generate report
  aggregate-results:
    name: Aggregate Test Results
    runs-on: ubuntu-latest
    needs:
      - setup
      - terraform-test
      - unit-tests
      - integration-tests
      - e2e-tests
      - security-tests
      - performance-tests
    if: ${{ always() && needs.setup.outputs.has-node == 'true' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Merge coverage reports
      run: |
        npm install -g nyc

        # Merge unit test coverage
        nyc merge artifacts/coverage-unit-* coverage/unit

        # Merge integration test coverage
        nyc merge artifacts/coverage-integration-* coverage/integration

        # Generate combined report
        nyc report \
          --reporter=lcov \
          --reporter=text \
          --reporter=html \
          --report-dir=coverage/combined

    - name: Upload combined coverage
      uses: codecov/codecov-action@v4
      with:
        directory: coverage/combined
        flags: combined
        fail_ci_if_error: false

    - name: Generate test summary
      run: |
        cat > test-summary.md << 'EOF'
        # Test Execution Summary

        ## Parallel Execution Statistics

        | Test Type | Shards | Status |
        |-----------|--------|--------|
        | Terraform | 12 modules | ${{ needs.terraform-test.result }} |
        | Unit Tests | 4 shards | ${{ needs.unit-tests.result }} |
        | Integration | 8 services | ${{ needs.integration-tests.result }} |
        | E2E Tests | 3 shards | ${{ needs.e2e-tests.result }} |
        | Security | 5 categories | ${{ needs.security-tests.result }} |
        | Performance | 4 endpoints | ${{ needs.performance-tests.result }} |

        ## Coverage Summary

        $(cat coverage/combined/lcov.info | grep -E '^(SF|DA)' | wc -l) lines covered

        ## Performance Benchmarks

        - API Gateway: $(cat artifacts/performance-results-api-gateway/summary-*.json | jq -r '.metrics.http_req_duration.values.p95')ms (p95)
        - LLM Gateway: $(cat artifacts/performance-results-llm-gateway/summary-*.json | jq -r '.metrics.http_req_duration.values.p95')ms (p95)

        EOF

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test-summary.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

    - name: Upload test summary
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: |
          test-summary.md
          coverage/combined/
        retention-days: 30

  # Job 10: Notify results
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: aggregate-results
    if: always()

    steps:
    - name: Notify Slack on success
      if: success()
      run: |
        curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "âœ… Parallel test suite passed",
            "attachments": [{
              "color": "good",
              "title": "Test Execution Complete",
              "fields": [
                {"title": "Total Shards", "value": "32", "short": true},
                {"title": "Duration", "value": "~8 minutes", "short": true},
                {"title": "Commit", "value": "'${{ github.sha }}'", "short": false}
              ]
            }]
          }'

    - name: Notify Slack on failure
      if: failure()
      run: |
        curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "âŒ Parallel test suite failed",
            "attachments": [{
              "color": "danger",
              "title": "Test Execution Failed",
              "text": "Check GitHub Actions for details",
              "fields": [
                {"title": "Commit", "value": "'${{ github.sha }}'", "short": false}
              ]
            }]
          }'
