name: Terraform CI (Optimized)
on:
  push:
    branches: [main, develop]
    paths: [terraform/**]
  pull_request:
    branches: [main, develop]
    paths: [terraform/**]
  workflow_dispatch:
env:
  TERRAFORM_VERSION: 1.11.0
jobs:
  # Single job for all module validation
  terraform-validate-all:
    name: Validate All Modules
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Validate all modules
        run: |
          echo "ðŸ” Validating all Terraform modules..."
          FAILED_MODULES=()
          PASSED_MODULES=()

          # Find all module directories (those containing *.tf files)
          for module_dir in terraform/modules/*/; do
            module_name=$(basename "$module_dir")
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“¦ Module: $module_name"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd "$module_dir"

            # Initialize
            if terraform init -backend=false > /dev/null 2>&1; then
              echo "  âœ… Init successful"
            else
              echo "  âŒ Init failed"
              FAILED_MODULES+=("$module_name (init)")
              cd "$GITHUB_WORKSPACE"
              continue
            fi

            # Validate
            if terraform validate > /dev/null 2>&1; then
              echo "  âœ… Validate successful"
            else
              echo "  âŒ Validate failed"
              FAILED_MODULES+=("$module_name (validate)")
              cd "$GITHUB_WORKSPACE"
              continue
            fi

            # Format check
            if terraform fmt -check -recursive > /dev/null 2>&1; then
              echo "  âœ… Format check passed"
            else
              echo "  âš ï¸  Format check failed (run 'terraform fmt')"
              FAILED_MODULES+=("$module_name (fmt)")
            fi
            PASSED_MODULES+=("$module_name")
            cd "$GITHUB_WORKSPACE"
          done

          # Summary
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š VALIDATION SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Passed: ${#PASSED_MODULES[@]}"
          echo "âŒ Failed: ${#FAILED_MODULES[@]}"
          if [ ${#FAILED_MODULES[@]} -gt 0 ]; then
            echo ""
            echo "Failed modules:"
            printf '  - %s\n' "${FAILED_MODULES[@]}"
            exit 1
          fi
          echo ""
          echo "âœ… All modules validated successfully!"

  # Single job for all module tests
  terraform-test-all:
    name: Test All Modules
    runs-on: ubuntu-latest
    needs: terraform-validate-all
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Test all modules
        run: |
          echo "ðŸ§ª Testing all Terraform modules..."
          FAILED_MODULES=()
          PASSED_MODULES=()
          SKIPPED_MODULES=()

          # Find all module directories with test files
          for module_dir in terraform/modules/*/; do
            module_name=$(basename "$module_dir")

            # Check if tests directory exists
            if [ ! -d "${module_dir}tests" ]; then
              SKIPPED_MODULES+=("$module_name (no tests)")
              continue
            fi
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ§ª Testing: $module_name"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd "$module_dir"

            # Initialize if needed
            if [ ! -d ".terraform" ]; then
              echo "  Initializing..."
              terraform init -backend=false > /dev/null 2>&1
            fi

            # Run tests
            if terraform test; then
              echo "  âœ… Tests passed"
              PASSED_MODULES+=("$module_name")
            else
              echo "  âŒ Tests failed"
              FAILED_MODULES+=("$module_name")
            fi
            cd "$GITHUB_WORKSPACE"
          done

          # Summary
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š TEST SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Passed:  ${#PASSED_MODULES[@]}"
          echo "âŒ Failed:  ${#FAILED_MODULES[@]}"
          echo "â­ï¸  Skipped: ${#SKIPPED_MODULES[@]}"
          if [ ${#PASSED_MODULES[@]} -gt 0 ]; then
            echo ""
            echo "Passed modules:"
            printf '  âœ… %s\n' "${PASSED_MODULES[@]}"
          fi
          if [ ${#SKIPPED_MODULES[@]} -gt 0 ]; then
            echo ""
            echo "Skipped modules:"
            printf '  â­ï¸  %s\n' "${SKIPPED_MODULES[@]}"
          fi
          if [ ${#FAILED_MODULES[@]} -gt 0 ]; then
            echo ""
            echo "Failed modules:"
            printf '  âŒ %s\n' "${FAILED_MODULES[@]}"
            exit 1
          fi
          echo ""
          echo "âœ… All tests passed!"

  # Environment validation (optional - validates actual env configs)
  terraform-validate-environments:
    name: Validate Environments
    runs-on: ubuntu-latest
    needs: terraform-validate-all
    strategy:
      matrix:
        env: [dev, staging, prod]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      - name: Check if environment exists
        id: check_env
        run: |
          if [ -d "terraform/environments/${{ matrix.env }}" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Terraform Init
        if: steps.check_env.outputs.exists == 'true'
        working-directory: terraform/environments/${{ matrix.env }}
        run: terraform init -backend=false
      - name: Terraform Validate
        if: steps.check_env.outputs.exists == 'true'
        working-directory: terraform/environments/${{ matrix.env }}
        run: terraform validate
      - name: Terraform Format Check
        if: steps.check_env.outputs.exists == 'true'
        working-directory: terraform/environments/${{ matrix.env }}
        run: terraform fmt -check

  # Summary job
  terraform-ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - terraform-validate-all
      - terraform-test-all
      - terraform-validate-environments
    if: always()
    steps:
      - name: Generate summary
        run: |-
          {
            echo "# Terraform CI Summary"
            echo ""
            echo "| Job | Status |"
            echo "|-----|--------|"
            echo "| Module Validation | ${{ needs.terraform-validate-all.result }} |"
            echo "| Module Tests | ${{ needs.terraform-test-all.result }} |"
            echo "| Environment Validation | ${{ needs.terraform-validate-environments.result }} |"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ needs.terraform-validate-all.result }}" == "success" ] && \
             [ "${{ needs.terraform-test-all.result }}" == "success" ] && \
             [ "${{ needs.terraform-validate-environments.result }}" == "success" ]; then
            {
              echo ""
              echo "âœ… **All Terraform checks passed!**"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo ""
              echo "âŒ **Some Terraform checks failed. Please review the logs.**"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
