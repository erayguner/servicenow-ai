name: Terraform Auto-Format

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'terraform/**/*.tf'
      - 'bedrock-agents-infrastructure/terraform/**/*.tf'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  terraform-format:
    name: Auto-format Terraform files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.11.0

      - name: Format Terraform files
        id: fmt
        run: |
          echo "ðŸ”§ Formatting Terraform files..."

          # Format all terraform directories
          FORMATTED_FILES=()

          # Format main terraform directory
          if [ -d "terraform" ]; then
            echo "Formatting terraform/..."
            cd terraform
            terraform fmt -recursive
            cd ..

            # Check for changes
            if ! git diff --quiet terraform/; then
              FORMATTED_FILES+=("terraform/")
            fi
          fi

          # Format bedrock-agents-infrastructure
          if [ -d "bedrock-agents-infrastructure/terraform" ]; then
            echo "Formatting bedrock-agents-infrastructure/terraform/..."
            cd bedrock-agents-infrastructure/terraform
            terraform fmt -recursive
            cd ../..

            # Check for changes
            if ! git diff --quiet bedrock-agents-infrastructure/terraform/; then
              FORMATTED_FILES+=("bedrock-agents-infrastructure/terraform/")
            fi
          fi

          # Check if any files were formatted
          if [ ${#FORMATTED_FILES[@]} -eq 0 ]; then
            echo "âœ… All Terraform files are already formatted correctly"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "ðŸ“ Formatted files in: ${FORMATTED_FILES[*]}"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit formatted files
        if: steps.fmt.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "style(terraform): auto-format Terraform files with terraform fmt

          Applied terraform fmt -recursive to ensure consistent formatting.

          [skip ci]"

      - name: Push changes
        if: steps.fmt.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.head_ref }}

      - name: Comment on PR
        if: steps.fmt.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Terraform files have been automatically formatted**\n\nApplied `terraform fmt -recursive` to ensure consistent formatting across all Terraform files.'
            })

      - name: Summary
        run: |
          if [ "${{ steps.fmt.outputs.has_changes }}" == "true" ]; then
            echo "ðŸ“ **Terraform files were formatted and committed**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âœ… **All Terraform files were already formatted correctly**" >> "$GITHUB_STEP_SUMMARY"
          fi
